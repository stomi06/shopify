<!-- filepath: c:\Users\Michał\Desktop\freedelivery\extensions\free-shipping-bar\blocks\shipping-bar.liquid -->
{%- if block.settings.enabled -%}
  <div id="free-shipping-bar-container" data-shop="{{ shop.permanent_domain }}"></div>
  
  <script>
    // Skrypt pobierający ustawienia z API aplikacji i renderujący pasek
    document.addEventListener('DOMContentLoaded', function() {
      fetch('/apps/free-delivery/settings?shop={{ shop.permanent_domain }}')
        .then(response => response.json())
        .then(settings => {
          if (settings && settings.active) {
            renderShippingBar(settings);
          }
        })
        .catch(error => console.error('Error loading free shipping bar settings:', error));
    });
    
    function renderShippingBar(settings) {
      const container = document.getElementById('free-shipping-bar-container');
      
      // Utwórz pasek
      const barElement = document.createElement('div');
      barElement.id = 'free-shipping-bar';
      barElement.style.backgroundColor = settings.bar_color || '#4CAF50';
      barElement.style.color = settings.text_color || '#FFFFFF';
      barElement.style.padding = '10px 0';
      barElement.style.textAlign = 'center';
      barElement.style.width = '100%';
      barElement.style.zIndex = 1000;
      
      // Pobierz informacje o koszyku
      fetch('/cart.js')
        .then(response => response.json())
        .then(cart => {
          const cartTotal = cart.total_price / 100;
          const threshold = parseFloat(settings.threshold || 200);
          let message = '';
          
          if (cartTotal >= threshold) {
            barElement.style.backgroundColor = settings.success_color || '#50b83c';
            message = settings.success_message || "Gratulacje! Masz darmową dostawę!";
          } else {
            const remaining = (threshold - cartTotal).toFixed(2);
            message = settings.message_template?.replace('{threshold}', threshold).replace('{remaining}', remaining) || 
                     `Dodaj produkty za ${remaining} zł, aby otrzymać darmową dostawę!`;
          }
          
          barElement.textContent = message;
          
          // Dodaj pasek do kontenera
          container.innerHTML = '';
          container.appendChild(barElement);
        })
        .catch(error => {
          console.error('Error loading cart:', error);
          barElement.textContent = `Darmowa dostawa od ${settings.threshold || 200} zł!`;
          container.innerHTML = '';
          container.appendChild(barElement);
        });
    }
  </script>
  
  <style>
    /* Podstawowe style */
    #free-shipping-bar-container {
      width: 100%;
      z-index: 999;
    }
  </style>
{%- endif -%}

{% schema %}
{
  "name": "Free Shipping Bar",
  "target": "body",
  "settings": [
    {
      "type": "header",
      "content": "Włączanie paska darmowej dostawy"
    },
    {
      "type": "checkbox",
      "id": "enabled",
      "label": "Włącz pasek",
      "default": true,
      "info": "Wszystkie szczegółowe ustawienia dostosuj w panelu aplikacji"
    },
    {
      "type": "select",
      "id": "position",
      "label": "Pozycja paska",
      "options": [
        {"value": "top", "label": "Góra strony"},
        {"value": "under_header", "label": "Pod nagłówkiem"},
        {"value": "bottom", "label": "Dół strony"}
      ],
      "default": "top"
    }
  ]
}
{% endschema %}