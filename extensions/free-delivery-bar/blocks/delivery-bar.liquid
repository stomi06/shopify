{% comment %}
  Free Delivery Bar Block
  Ustawienia są zarządzane przez panel aplikacji
{% endcomment %}

<div class="free-delivery-bar" 
     id="free-delivery-bar"
     data-shop="{{ shop.permanent_domain }}"
     style="display: none; text-align: center; padding: 12px 20px; font-weight: 600; position: relative; z-index: 1000;">
  
  <span id="delivery-message">Ładowanie...</span>
  
  <button id="close-delivery-bar" 
          style="background: none; border: none; color: inherit; float: right; cursor: pointer; font-size: 18px; line-height: 1; padding: 0; margin-left: 10px; display: none;">×</button>
</div>

<script>
(function() {
  const deliveryBar = document.getElementById('free-delivery-bar');
  const messageElement = document.getElementById('delivery-message');
  const closeButton = document.getElementById('close-delivery-bar');
  
  if (!deliveryBar) return;
  
  const shop = deliveryBar.getAttribute('data-shop');
  let appSettings = null;
  
  // Pobierz ustawienia z aplikacji
  async function loadAppSettings() {
    try {
      const response = await fetch(`https://shopify-ige3.onrender.com/api/delivery-bar/${shop}`);
      
      if (!response.ok) {
        throw new Error('Nie można pobrać ustawień');
      }
      
      appSettings = await response.json();
      console.log('Ustawienia aplikacji:', appSettings);
      
      // Zastosuj style z ustawień
      deliveryBar.style.backgroundColor = appSettings.background_color || '#4CAF50';
      deliveryBar.style.color = appSettings.text_color || '#ffffff';
      
      // Ustaw pozycję
      if (appSettings.position === 'bottom') {
        deliveryBar.style.position = 'fixed';
        deliveryBar.style.bottom = '0';
        deliveryBar.style.left = '0';
        deliveryBar.style.right = '0';
      }
      
      // Pokaż przycisk zamknięcia jeśli włączony
      if (appSettings.closeable) {
        closeButton.style.display = 'block';
      }
      
      // Pokaż pasek
      deliveryBar.style.display = 'block';
      
      // Zaktualizuj wiadomość na podstawie koszyka
      updateDeliveryMessage();
      
    } catch (error) {
      console.error('Błąd ładowania ustawień aplikacji:', error);
      // Ukryj pasek jeśli nie można pobrać ustawień
      deliveryBar.style.display = 'none';
    }
  }
  
  // Aktualizuj wiadomość na podstawie wartości koszyka
  function updateDeliveryMessage() {
    if (!appSettings) return;
    
    fetch('/cart.js')
      .then(response => response.json())
      .then(cart => {
        const cartTotal = cart.total_price / 100; // Shopify zwraca w groszach
        const threshold = appSettings.min_amount || 199;
        
        if (cartTotal >= threshold) {
          messageElement.innerHTML = '🎉 Masz darmową dostawę!';
          deliveryBar.style.backgroundColor = '#4CAF50';
        } else {
          const remaining = threshold - cartTotal;
          let message = appSettings.message || '🚚 Darmowa dostawa przy zamówieniu powyżej {amount} zł!';
          
          // Zastąp {amount} rzeczywistą kwotą
          message = message.replace('{amount}', threshold + ' zł');
          message = message.replace('{remaining}', remaining.toFixed(2) + ' zł');
          
          messageElement.innerHTML = message;
          deliveryBar.style.backgroundColor = appSettings.background_color || '#FF9800';
        }
      })
      .catch(() => {
        // Fallback - pokaż domyślną wiadomość
        let message = appSettings.message || '🚚 Darmowa dostawa przy zamówieniu powyżej {amount} zł!';
        message = message.replace('{amount}', (appSettings.min_amount || 199) + ' zł');
        messageElement.innerHTML = message;
      });
  }
  
  // Obsługa zamknięcia paska
  closeButton.addEventListener('click', function() {
    deliveryBar.style.display = 'none';
    // Zapisz w localStorage, że użytkownik zamknął pasek
    localStorage.setItem('deliveryBarClosed', 'true');
  });
  
  // Sprawdź czy pasek był wcześniej zamknięty
  if (localStorage.getItem('deliveryBarClosed') === 'true') {
    deliveryBar.style.display = 'none';
    return;
  }
  
  // Załaduj ustawienia przy starcie
  loadAppSettings();
  
  // Nasłuchuj zmian w koszyku
  document.addEventListener('cart:updated', updateDeliveryMessage);
  
})();
</script>

{% schema %}
{
  "name": "Free Delivery Bar",
  "target": "section",
  "settings": [
    {
      "type": "paragraph",
      "content": "Wszystkie ustawienia (wiadomość, kolory, kwota) są zarządzane przez panel aplikacji. Ten blok tylko wyświetla pasek na stronie."
    },
    {
      "type": "paragraph", 
      "content": "Aby skonfigurować pasek, przejdź do: Apps → Free Delivery → Ustawienia"
    }
  ]
}
{% endschema %}
