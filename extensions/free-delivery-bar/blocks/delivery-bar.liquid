{% comment %}
  Free Delivery Bar Block
  Wyświetla pasek z informacją o darmowej dostawie
{% endcomment %}

<div class="free-delivery-bar" 
     id="free-delivery-bar"
     data-shop="{{ shop.permanent_domain }}"
     data-threshold="{{ block.settings.min_amount | default: 199 }}"
     style="
       background-color: {{ block.settings.background_color | default: '#4CAF50' }};
       color: {{ block.settings.text_color | default: '#ffffff' }};
       text-align: center;
       padding: 12px 20px;
       font-weight: 600;
       position: relative;
       z-index: 1000;
       {% if block.settings.position == 'bottom' %}
         position: fixed;
         bottom: 0;
         left: 0;
         right: 0;
       {% endif %}
     ">
  
  <span id="delivery-message">
    {% if block.settings.message != blank %}
      {{ block.settings.message }}
    {% else %}
      🚚 Darmowa dostawa przy zamówieniu powyżej {{ block.settings.min_amount | default: 199 }} zł!
    {% endif %}
  </span>
  
  {% if block.settings.closeable %}
    <button onclick="this.parentElement.style.display='none'" 
            style="
              background: none;
              border: none;
              color: inherit;
              float: right;
              cursor: pointer;
              font-size: 18px;
              line-height: 1;
              padding: 0;
              margin-left: 10px;
            ">×</button>
  {% endif %}
</div>

<script>
// Dynamiczna aktualizacja wiadomości na podstawie wartości koszyka
(function() {
  const deliveryBar = document.getElementById('free-delivery-bar');
  if (!deliveryBar) return;
  
  const threshold = parseInt(deliveryBar.getAttribute('data-threshold'));
  
  // Funkcja do aktualizacji wiadomości na podstawie wartości koszyka
  function updateDeliveryMessage() {
    // Pobierz aktualną wartość koszyka z Shopify
    fetch('/cart.js')
      .then(response => response.json())
      .then(cart => {
        const cartTotal = cart.total_price / 100; // Shopify zwraca w groszach
        const messageElement = document.getElementById('delivery-message');
        
        if (cartTotal >= threshold) {
          messageElement.innerHTML = '🎉 Masz darmową dostawę!';
          deliveryBar.style.backgroundColor = '#4CAF50';
        } else {
          const remaining = threshold - cartTotal;
          messageElement.innerHTML = `🚚 Dodaj za ${remaining.toFixed(2)} zł i otrzymasz darmową dostawę!`;
          deliveryBar.style.backgroundColor = '#FF9800';
        }
      })
      .catch(() => {
        // Fallback - pokaż domyślną wiadomość
        console.log('Nie można pobrać informacji o koszyku');
      });
  }
  
  // Zaktualizuj przy załadowaniu strony
  updateDeliveryMessage();
  
  // Nasłuchuj zmian w koszyku
  document.addEventListener('cart:updated', updateDeliveryMessage);
  
})();
</script>

{% schema %}
{
  "name": "Free Delivery Bar",
  "target": "section",
  "stylesheet": "free-delivery-bar.css",
  "javascript": "free-delivery-bar.js",
  "settings": [
    {
      "type": "text",
      "id": "message",
      "label": "Wiadomość",
      "default": "🚚 Darmowa dostawa powyżej {amount} zł!",
      "info": "Tekst wyświetlany na pasku. Użyj {amount} jako placeholder"
    },
    {
      "type": "number",
      "id": "min_amount",
      "label": "Minimalna kwota (zł)",
      "default": 199
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Kolor tła",
      "default": "#4CAF50"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Kolor tekstu",
      "default": "#ffffff"
    },
    {
      "type": "select",
      "id": "position",
      "label": "Pozycja paska",
      "options": [
        {
          "value": "top",
          "label": "Góra strony"
        },
        {
          "value": "bottom",
          "label": "Dół strony (sticky)"
        }
      ],
      "default": "top"
    },
    {
      "type": "checkbox",
      "id": "closeable",
      "label": "Możliwość zamknięcia",
      "default": true,
      "info": "Pozwala użytkownikowi zamknąć pasek"
    }
  ]
}
{% endschema %}
