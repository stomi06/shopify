{% comment %}
  Free Delivery Bar Block
  Ustawienia sÄ… zarzÄ…dzane przez panel aplikacji
{% endcomment %}

<div class="free-delivery-bar" 
     id="free-delivery-bar"
     data-shop="{{ shop.permanent_domain }}"
     style="display: none; text-align: center; padding: 12px 20px; font-weight: 600; position: relative; z-index: 1000;">
  
  <span id="delivery-message">Åadowanie...</span>
  
  <button id="close-delivery-bar" 
          style="background: none; border: none; color: inherit; float: right; cursor: pointer; font-size: 18px; line-height: 1; padding: 0; margin-left: 10px; display: none;">Ã—</button>
</div>

<script>
(function() {
  const deliveryBar = document.getElementById('free-delivery-bar');
  const messageElement = document.getElementById('delivery-message');
  const closeButton = document.getElementById('close-delivery-bar');
  
  if (!deliveryBar) return;
  
  const shop = deliveryBar.getAttribute('data-shop');
  let appSettings = null;
  
  // Pobierz ustawienia z aplikacji
  async function loadAppSettings() {
    try {
      const response = await fetch(`https://shopify-ige3.onrender.com/api/delivery-bar/${shop}`);
      
      if (!response.ok) {
        throw new Error('Nie moÅ¼na pobraÄ‡ ustawieÅ„');
      }
      
      appSettings = await response.json();
      console.log('Ustawienia aplikacji:', appSettings);
      
      // Zastosuj style z ustawieÅ„
      deliveryBar.style.backgroundColor = appSettings.background_color || '#4CAF50';
      deliveryBar.style.color = appSettings.text_color || '#ffffff';
      
      // Ustaw pozycjÄ™
      if (appSettings.position === 'bottom') {
        deliveryBar.style.position = 'fixed';
        deliveryBar.style.bottom = '0';
        deliveryBar.style.left = '0';
        deliveryBar.style.right = '0';
      }
      
      // PokaÅ¼ przycisk zamkniÄ™cia jeÅ›li wÅ‚Ä…czony
      if (appSettings.closeable) {
        closeButton.style.display = 'block';
      }
      
      // PokaÅ¼ pasek
      deliveryBar.style.display = 'block';
      
      // Zaktualizuj wiadomoÅ›Ä‡ na podstawie koszyka
      updateDeliveryMessage();
      
    } catch (error) {
      console.error('BÅ‚Ä…d Å‚adowania ustawieÅ„ aplikacji:', error);
      // Ukryj pasek jeÅ›li nie moÅ¼na pobraÄ‡ ustawieÅ„
      deliveryBar.style.display = 'none';
    }
  }
  
  // Aktualizuj wiadomoÅ›Ä‡ na podstawie wartoÅ›ci koszyka
  function updateDeliveryMessage() {
    if (!appSettings) return;
    
    fetch('/cart.js')
      .then(response => response.json())
      .then(cart => {
        const cartTotal = cart.total_price / 100; // Shopify zwraca w groszach
        const threshold = appSettings.min_amount || 199;
        
        if (cartTotal >= threshold) {
          messageElement.innerHTML = 'ğŸ‰ Masz darmowÄ… dostawÄ™!';
          deliveryBar.style.backgroundColor = '#4CAF50';
        } else {
          const remaining = threshold - cartTotal;
          let message = appSettings.message || 'ğŸšš Darmowa dostawa przy zamÃ³wieniu powyÅ¼ej {amount} zÅ‚!';
          
          // ZastÄ…p {amount} rzeczywistÄ… kwotÄ…
          message = message.replace('{amount}', threshold + ' zÅ‚');
          message = message.replace('{remaining}', remaining.toFixed(2) + ' zÅ‚');
          
          messageElement.innerHTML = message;
          deliveryBar.style.backgroundColor = appSettings.background_color || '#FF9800';
        }
      })
      .catch(() => {
        // Fallback - pokaÅ¼ domyÅ›lnÄ… wiadomoÅ›Ä‡
        let message = appSettings.message || 'ğŸšš Darmowa dostawa przy zamÃ³wieniu powyÅ¼ej {amount} zÅ‚!';
        message = message.replace('{amount}', (appSettings.min_amount || 199) + ' zÅ‚');
        messageElement.innerHTML = message;
      });
  }
  
  // ObsÅ‚uga zamkniÄ™cia paska
  closeButton.addEventListener('click', function() {
    deliveryBar.style.display = 'none';
    // Zapisz w localStorage, Å¼e uÅ¼ytkownik zamknÄ…Å‚ pasek
    localStorage.setItem('deliveryBarClosed', 'true');
  });
  
  // SprawdÅº czy pasek byÅ‚ wczeÅ›niej zamkniÄ™ty
  if (localStorage.getItem('deliveryBarClosed') === 'true') {
    deliveryBar.style.display = 'none';
    return;
  }
  
  // ZaÅ‚aduj ustawienia przy starcie
  loadAppSettings();
  
  // NasÅ‚uchuj zmian w koszyku
  document.addEventListener('cart:updated', updateDeliveryMessage);
  
})();
</script>

{% schema %}
{
  "name": "Free Delivery Bar",
  "target": "section",
  "settings": [
    {
      "type": "paragraph",
      "content": "Wszystkie ustawienia (wiadomoÅ›Ä‡, kolory, kwota) sÄ… zarzÄ…dzane przez panel aplikacji. Ten blok tylko wyÅ›wietla pasek na stronie."
    },
    {
      "type": "paragraph", 
      "content": "Aby skonfigurowaÄ‡ pasek, przejdÅº do: Apps â†’ Free Delivery â†’ Ustawienia"
    }
  ]
}
{% endschema %}
