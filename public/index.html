<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Free Delivery Bar - Panel administracyjny</title>
  <link rel="stylesheet" href="https://unpkg.com/@shopify/polaris/dist/styles.css">
  <script src="https://unpkg.com/@shopify/app-bridge@3"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .card { background: white; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px; }
    .btn { background: #5c6ac4; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
    .btn:hover { background: #4959bd; }
    .header { display: flex; justify-content: space-between; align-items: center; }
    .subscription-banner { background: #fdf8e3; border-left: 4px solid #eec200; padding: 15px; margin-bottom: 20px; }
    .tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 20px; }
    .tab { padding: 10px 20px; cursor: pointer; }
    .tab.active { border-bottom: 2px solid #5c6ac4; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .setting-group { margin-bottom: 25px; padding: 20px; border: 1px solid #eee; border-radius: 4px; }
    .setting-title { font-weight: bold; margin-bottom: 15px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; }
    .form-control { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    .color-picker { width: 50px; height: 30px; }
    .btn-primary { background: #5c6ac4; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
    .preview { border: 1px solid #ddd; padding: 20px; margin: 20px 0; border-radius: 4px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Free Delivery Bar - Ustawienia</h1>
    
    <!-- Pasek statusu subskrypcji -->
    <div id="subscription-status"></div>
    
    <!-- Zakładki -->
    <div class="tabs">
      <div class="tab active" data-tab="basic">Podstawowe</div>
      <div class="tab" data-tab="appearance">Wygląd</div>
      <div class="tab" data-tab="advanced">Zaawansowane</div>
      <div class="tab" data-tab="preview">Podgląd</div>
    </div>
    
    <!-- Formularz ustawień -->
    <form id="settings-form">
      <!-- Podstawowe ustawienia -->
      <div class="tab-content active" id="basic-content">
        <div class="setting-group">
          <div class="setting-title">Ustawienia ogólne</div>
          
          <div class="form-group">
            <label>
              <input type="checkbox" name="active" id="active"> 
              Włącz pasek darmowej dostawy
            </label>
          </div>
          
          <div class="form-group">
            <label for="threshold">Próg darmowej dostawy (zł)</label>
            <input type="number" class="form-control" name="threshold" id="threshold" value="200">
          </div>
          
          <div class="form-group">
            <label>
              <input type="checkbox" name="calculate_difference" id="calculate_difference"> 
              Obliczaj różnicę do progu
            </label>
          </div>
          
          <div class="form-group">
            <label>
              <input type="checkbox" name="show_success_message" id="show_success_message"> 
              Pokazuj komunikat po osiągnięciu progu
            </label>
          </div>
        </div>
        
        <div class="setting-group">
          <div class="setting-title">Wiadomości</div>
          
          <div class="form-group">
            <label for="message_template">Szablon wiadomości</label>
            <input type="text" class="form-control" name="message_template" id="message_template" 
                   value="Darmowa dostawa od {threshold} zł">
            <small>Użyj {threshold} dla kwoty progu, {remaining} dla pozostałej kwoty</small>
          </div>
          
          <div class="form-group">
            <label for="loading_message">Wiadomość podczas ładowania</label>
            <input type="text" class="form-control" name="loading_message" id="loading_message" 
                   value="Sprawdzam koszyk...">
          </div>
          
          <div class="form-group">
            <label for="success_message">Wiadomość sukcesu</label>
            <input type="text" class="form-control" name="success_message" id="success_message" 
                   value="Gratulacje! Masz darmową dostawę :)">
          </div>
        </div>
      </div>
      
      <!-- Ustawienia wyglądu -->
      <div class="tab-content" id="appearance-content">
        <!-- Tu dodaj pola do ustawień wyglądu: kolory, czcionki, itp. -->
      </div>
      
      <!-- Ustawienia zaawansowane -->
      <div class="tab-content" id="advanced-content">
        <!-- Tu dodaj zaawansowane ustawienia -->
      </div>
      
      <!-- Podgląd -->
      <div class="tab-content" id="preview-content">
        <div class="preview">
          <div id="bar-preview">Darmowa dostawa od 200 zł</div>
        </div>
      </div>
      
      <button type="submit" class="btn-primary">Zapisz ustawienia</button>
    </form>
  </div>
  
  <script>
    // Obsługa zakładek
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', function() {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        this.classList.add('active');
        document.getElementById(this.dataset.tab + '-content').classList.add('active');
      });
    });
    
    // Obsługa formularza
    document.getElementById('settings-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      const settings = {};
      
      formData.forEach((value, key) => {
        settings[key] = value;
      });
      
      try {
        const response = await fetch('/api/settings/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(settings)
        });
        
        if (response.ok) {
          alert('Ustawienia zostały zapisane!');
        } else {
          alert('Wystąpił błąd podczas zapisywania ustawień.');
        }
      } catch (error) {
        console.error('Błąd:', error);
        alert('Wystąpił błąd podczas zapisywania ustawień.');
      }
    });
    
    // Ładowanie ustawień
    async function loadSettings() {
      try {
        const response = await fetch('/api/settings');
        if (response.ok) {
          const settings = await response.json();
          
          // Wypełnij formularz
          Object.keys(settings).forEach(key => {
            const input = document.getElementById(key);
            if (input) {
              if (input.type === 'checkbox') {
                input.checked = settings[key];
              } else {
                input.value = settings[key];
              }
            }
          });
        }
      } catch (error) {
        console.error('Błąd ładowania ustawień:', error);
      }
    }
    
    // Sprawdź status subskrypcji
    async function checkSubscription() {
      try {
        const response = await fetch('/api/subscription/check');
        const data = await response.json();
        
        if (data.active) {
          document.getElementById('subscription-status').innerHTML = `
            <div style="background: #e3f1df; border-left: 4px solid #50b83c; padding: 15px; margin-bottom: 20px;">
              <h3>✅ Subskrypcja aktywna</h3>
              <p>Masz pełny dostęp do wszystkich funkcji Free Delivery Bar.</p>
            </div>
          `;
        } else {
          document.getElementById('subscription-status').innerHTML = `
            <div style="background: #fdf8e3; border-left: 4px solid #eec200; padding: 15px; margin-bottom: 20px;">
              <h3>🔔 Brak aktywnej subskrypcji</h3>
              <p>Aby korzystać z Free Delivery Bar, musisz aktywować subskrypcję.</p>
              <button id="subscribe-btn" style="background: #5c6ac4; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                Aktywuj subskrypcję (7 dni za darmo)
              </button>
            </div>
          `;
          
          document.getElementById('subscribe-btn').addEventListener('click', createSubscription);
        }
      } catch (error) {
        console.error('Błąd sprawdzania subskrypcji:', error);
      }
    }
    
    // Inicjalizacja
    document.addEventListener('DOMContentLoaded', function() {
      loadSettings();
      checkSubscription();
    });
  </script>
</body>
</html>